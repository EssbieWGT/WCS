<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="format-detection" contnet="telephone=no">
  <meta name="viewport" content="width=device-width">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>{{ filename[:-4].upper() }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='eb.css') }}">
  <script src="https://d3js.org/d3.v4.js"></script>
</head>

<body>

    {% if navigation %}
  <div class="nav-header">
      <a href="{{ url_for('main_page') }}" class="btn btn-primary">Home</a>
      <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
  </div>
  <hr>
  {% endif %}


  <!-- Opening DIV for container -->
  <div class="containerwgt" style="width:90%">
<div id="etitle"></div> <br>
    
</br><div id='headCats'></div>
<hr>
<div id='bodyCats'></div>

<!-- closing div for container -->
</div>

<script>
//define replaceAt
String.prototype.replaceAt=function(index, replacement) {
    return this.substr(0, index) + replacement+ this.substr(index + replacement.length);
}

//define date of run
var d = new Date();
var dFormat = new Intl.DateTimeFormat('en', {
	month: 'long',
	day: 'numeric',
  year: 'numeric',
  hour: 'numeric',
  minute: 'numeric',
  hour12: true,
  timeZone: 'America/New_York'
});

const today = new Date();
const formattedDate = today.toLocaleDateString('en-US', {
  year: 'numeric',
  month: '2-digit',
  day: '2-digit'
});

document.getElementById("etitle").innerHTML = "{{ filename[:-4].upper() }} | Top News - " + formattedDate

// load the data
d3.queue()
  .defer(d3.csv, "{{ url_for('uploads', filename=filename[:-4].lower() + 'view.csv' ) }}")
  .await(analyze);

  function analyze(error, article) {
    if(error) { console.log(error); }

//define unique entries in category (note, categories should be sorted already)
categoryData = []
const categories = [...new Set(article.map(article => article['category']))]

const getHostname = (url) => {
    // use URL constructor and return hostname
    return new URL(url).hostname;
  }

categories.forEach(function(data,index){

console.log(data)
console.log(index+1)
var indexUse = index+1

d3.select('#headCats')
    .data(data)
    .append("table")
    .attr("id","c"+ indexUse)
    .append("p")
    .style("font-weight","bold")
    .style("font-size", "28px")
    .text(data)
	  .style("font-weight","bold")
    .style("margin-bottom", "10px")
});

article.forEach(function(data){

  data['selector'] = "#c"+data['categoryorder']
  data['body'] = data['selector']+"body"
  data['uniqueIDs'] = "c" + data["categoryorder"]+data["articleorder"]

  if (data.published === null){
    date = "No Date"
  }else {
    date = new Date(data.published).toLocaleString()
  }

//had to play around with this one a little, it appears that todayURL is always present 
domain = data.domain ?? getHostname(data.url)

  d3.selectAll(data['selector'])
    .append("table")
    .style("width","50%")
    .append("tr")
    .style("font-size", "16px")
    // .style("border-bottom","1px solid #ddd")
    .each(function(d){
      d3.select(this)
      .append("td")
      .style('line-height',"1")
      .style("text-align","left")
      // .html('<p style="font-weight: normal;"><small class="text_muted">' + data.outlet + ' | ' + date + '</small><br><b><a href="' +data.url + '"target="_blank">' + data.title + '</a></b><br>' + '<small class="text_muted">By: ' + data.authors + ' |  Market: ' + data.market + '</small><br><br>' + data.description + '<br></p>');
      // .html(
      //   '<div style="margin:0;padding:0;line-height:1.15;">' +

      //     // outlet | date
      //     '<div style="margin:0;padding:0;line-height:1.15;">' +
      //       '<span style="font-weight:normal;font-size:14px;color:#666;margin:0;padding:0;">' +
      //         data.outlet + ' | ' + date +
      //       '</span>' +
      //     '</div>' +

      //     // title
      //     '<div style="margin:0;padding:0;line-height:1.15;">' +
      //       '<a href="' + data.url + '" target="_blank" ' +
      //         'style="font-weight:700;font-size:18px;color:inherit;text-decoration:none;margin:0;padding:0;line-height:1.15;">' +
      //         data.title +
      //       '</a>' +
      //     '</div>' +

      //     // byline
      //     '<div style="margin:0;padding:0;line-height:1.15;">' +
      //       '<span style="font-weight:normal;font-size:14px;color:#666;margin:0;padding:0;">' +
      //         'By: ' + (data.authors || '') + ' | Market: ' + (data.market || '') +
      //       '</span>' +
      //     '</div>' +

      //     // description (with a little breathing room)
      //     '<div style="margin:6px 0 0 0;padding:0;line-height:1.3;">' +
      //       (data.description || '') +
      //     '</div>' +

      //   '</div>'
      // );
      .html(
  '<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" ' +
         'style="border-collapse:collapse;width:100%;">' +
    '<tr>' +
      '<td style="font-family:Arial, sans-serif;padding:10px 0">' +

        // Outlet/date
        '<div style="margin:0;padding:0;font-size:14px;line-height:1.2;color:#666;">' +
          (data.outlet || '') + ' \u00A0|\u00A0 ' + (date || '') +
        '</div>' +

        // Title
        '<div style="margin:4px 0 0 0;padding:0;font-size:19px;line-height:1.25;font-weight:700;">' +
          '<a href="' + data.url + '" target="_blank" ' +
             'style="color:inherit;text-decoration:none;">' +
            (data.title || '') +
          '</a>' +
        '</div>' +

        // Byline
        '<div style="margin:4px 0 0 0;padding:0;font-size:14px;line-height:1.2;color:#666;">' +
          'By: ' + (data.authors || '—') + ' \u00A0|\u00A0 Market: ' + (data.market || '—') +
        '</div>' +

        // Description
        '<div style="margin:8px 0 0 0;padding:0;font-size:16px;line-height:1.35;color:#111;">' +
          (data.description || '') +
        '</div>' +
        // '<hr style = "1px solid #ddd">' +    
      '</td>' +
    '</tr>' +
  '</table>'
);



    })
});
}

// add in slug where available 

</script>

</body>
</html>