<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> Weekly H2 Client Report </title>
  <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='eb.css') }}">
  <script src="https://d3js.org/d3.v4.js"></script>
</head>

<body>

  {% if navigation %}
  <div class="nav-header">
      <a href="{{ url_for('main_page') }}" class="btn btn-primary">Home</a>
      <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
  </div>
  <hr>
  {% endif %}

<div class="containerwgt">
  <div class="heading">
    <h1> Weekly H2 Client Report </h1>
    <div id='current'></div>
    <h1> Index </h1>
  </div>

  <div id='top'></div>
  <h2> Top News </h2></br>
  <div id='headCats'></div>
  <hr>

  <h2> Earnings Releases</h2>
  <div id='earnings'></div>
</div>

<script>
// ---------- Encoding-safe CSV fetch ----------
async function fetchCSV(url, encodings = ['utf-8', 'windows-1252', 'iso-8859-1']) {
  const res = await fetch(url, { cache: 'no-cache' });
  const buf = await res.arrayBuffer();

  for (const enc of encodings) {
    try {
      const txt = new TextDecoder(enc, { fatal: false }).decode(new Uint8Array(buf));
      if (txt.includes('\uFFFD')) continue; // replacement char means bad decode
      return d3.csvParse(txt);
    } catch (e) { }
  }
  const fallback = new TextDecoder('utf-8').decode(new Uint8Array(buf));
  return d3.csvParse(fallback);
}

// cleanup helper
function cleanText(s) {
  if (s == null) return s;
  return String(s)
    .replace(/\uFFFD/g, '')
    .replace(/\u00A0/g, ' ');
}
function deepCleanRow(row) {
  const out = {};
  for (const k in row) out[k] = cleanText(row[k]);
  return out;
}

// ---------- Helpers ----------
String.prototype.replaceAt=function(index, replacement) {
  return this.substr(0, index) + replacement + this.substr(index + replacement.length);
}

var d = new Date();
var dFormat = new Intl.DateTimeFormat('en', {
  month: 'long',
  day: 'numeric',
  year: 'numeric',
  hour: 'numeric',
  minute: 'numeric',
  hour12: true,
  timeZone: 'America/New_York'
});
document.getElementById("current").innerHTML = dFormat.format(d) + " EDT";

// ---------- Load both CSVs ----------
Promise.all([
  fetchCSV("{{ url_for('uploads', filename=filename[:-4].lower() + 'view.csv' ) }}"),
  fetchCSV("{{ url_for('static', filename='companies.csv' ) }}")
]).then(([articleRaw, companiesRaw]) => {
  const article = articleRaw.map(deepCleanRow);
  const companies = companiesRaw.map(deepCleanRow);
  analyze(null, article, companies);
}).catch(err => {
  console.error('CSV load failed:', err);
});

// ---------- Main logic ----------
function analyze(error, article, companies) {
  if(error) { console.log(error); }

  let hasEarningsReport = false;

  const categories = [...new Set(companies.map(c => ({ id: c['id'], topic: c['name'] })))];
  categories.forEach(function(data,index){
    var idNum = data['id'];
    var topicName = data['topic'];

    d3.select('#headCats')
      .append("div")
      .attr("id", "c"+ idNum +"body")
      .append("div")
      .attr("id","c"+ idNum+"head")
      .html("<h3>" + topicName + "</h3><p>")
      .style("font-weight","bold");
  });

  article.forEach(function(data, index){
    var indexNum = index+1;
    var formatDate = data['published'] ? new Date(data['published']).toLocaleDateString() : '';

    data['selector']    = "#c"+data['id'];
    data['head']        = data['selector']+"head";
    data['body']        = data['selector']+"body";
    data['uniqueIDs']   = "c" + data["id"]+ "_" + indexNum;
    data['earningsIDs'] = "c" + data["id"]+ "_" + indexNum + "_earnings";

    d3.selectAll(data['head'])
      .append("ul")
      .attr("class","contents")
      .style("margin-left", "2em")
      .style("font-weight", 'normal')
      .html("<li><u>" + (data["outlet"]||'') + "</u> - " + (data["description"]||'') + "</li>" );

    d3.selectAll(data['body'])
      .append("div")
      .append("div")
      .attr("class","title_block")
      .html(
        "<strong><h4><a id=" + "link_" + data['uniqueIDs']+ " href=" + (data["url"]||'#') + " target='_blank'>" +
        (data["title"]||'') + "</a></h4>" +
        "Source: " + (data["outlet"]||'') +  "</br>" +
        "Author: " + (data["authors"]||'')  + "</br>" +
        "Date: " + (formatDate||'') +  "</strong></br></br>"
      )
      .each(function(d){
        d3.select(this)
          .append("p")
          .attr("class", "article-body")
          .attr("id", data['uniqueIDs']);
        d3.select(this)
          .append("hr");
      });

    if (data.category == "Earnings"){
      hasEarningsReport = true;

      d3.selectAll("#earnings")
        .append("div")
        .append("div")
        .attr("class","title_block")
        .html(
          "<b>Title:</b> <a id=" + "link_" + data['earningsIDs']+ " href=" + (data["url"]||'#') + " target='_blank'>" +
          (data["title"]||'') + "</a></br>" +
          "<b>Source:</b> " + (data["outlet"]||'') +  "</br>" +
          "<b>Author:</b> " + (data["authors"]||'')  + "</br>" +
          "<b>Date:</b> " + (formatDate||'') +  "</br></br>"
        )
        .each(function(d){
          d3.select(this)
            .append("p")
            .attr("class", "article-body")
            .attr("id", data['earningsIDs']);
          d3.select(this).append("hr");
        });

      var earningsText = document.getElementById(data['earningsIDs']);
      if (earningsText) earningsText.innerText = data["text"] || '';
    }
  });

  if (!hasEarningsReport) {
    d3.select("#earnings")
      .append("p")
      .style("margin-left", "2em")
      .style("font-style", "italic")
      .text("No Earnings Reports");
  }

  article.forEach(function(data){
    var bodyText = document.getElementById(data['uniqueIDs']);
    if (bodyText) bodyText.innerText = data["text"] || '';
  });

  moveEmptyTopicsToNoRelevantArticles();
}

// ---------- Move empty topics to “No Relevant Articles” ----------
function moveEmptyTopicsToNoRelevantArticles() {
  const bodyDivs = document.querySelectorAll("div[id^='c'][id$='body']");
  const emptyTopics = [];

  bodyDivs.forEach(bodyDiv => {
    const head = bodyDiv.querySelector("div[id$='head']");
    const isEmpty =
      bodyDiv.children.length === 1 &&
      head &&
      head.children.length === 2 &&
      head.firstElementChild.tagName === "H3" &&
      head.children[1].tagName === "P";

    if (isEmpty) {
      const name = head.querySelector("h3")?.textContent?.trim() || "Unknown";
      emptyTopics.push({ name, node: bodyDiv });
    }
  });

  if (emptyTopics.length === 0) return;

  const earnings = document.getElementById("earnings");
  if (!earnings) return;

  let heading = document.getElementById("noRelevantHeading");
  let list = document.getElementById("noRelevantArticles");

  if (!heading || !list) {
    heading = document.createElement("h2");
    heading.id = "noRelevantHeading";
    heading.textContent = "No Relevant Articles";

    list = document.createElement("ul");
    list.id = "noRelevantArticles";
    list.className = "contents";
    list.style.marginLeft = "2em";

    earnings.insertAdjacentElement("afterend", heading);
    heading.insertAdjacentElement("afterend", list);
  }

  emptyTopics.forEach(t => {
    const li = document.createElement("li");
    li.textContent = t.name;
    list.appendChild(li);
    t.node.parentNode.removeChild(t.node);
  });
}
</script>

</body>
</html>
