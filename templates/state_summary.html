<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>State News Viewer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='eb.css') }}">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    h2.main-group {
      border-bottom: 2px solid #333;
      padding-top: 1em;
      margin-top: 2em;
      font-size: 1.5rem;
    }
    h4.sub-group {
      margin-top: 1.25em;
      font-size: 1.1rem;
      font-weight: 600;
      color: #444;
    }
    p.article-entry {
      margin: 0.5em 0;
      font-size: 0.95rem;
    }
    p.article-entry small.outlet {
      display: block;
      font-weight: bold;
      color: #555;
      margin-bottom: 0.25em;
    }
    .toggle-buttons {
      margin-bottom: 1em;
    }
    .toggle-buttons .btn {
      margin-right: 0.5em;
    }

    /* "Last updated" styling */
    #lastUpdated {
      font-size: 0.9rem;
      color: #666;
      margin-top: -0.25rem;
      margin-bottom: 0.75rem;
    }

    /* NEW: Jump list styling */
    .jumpbox {
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 8px;
      padding: 0.75rem 0.75rem;
      margin: 0.25rem 0 1rem 0;
      background: rgba(0,0,0,0.02);
    }
    .jumpbox .jump-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .jumpbox .jump-links a {
      display: inline-block;
      margin: 0.15rem 0.5rem 0.15rem 0;
      padding: 0.15rem 0.35rem;
      border-radius: 6px;
      text-decoration: none;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fff;
      color: #0b5394;
      font-size: 0.9rem;
      line-height: 1.2;
    }
    .jumpbox .jump-links a:hover {
      background: rgba(11,83,148,0.06);
      text-decoration: none;
    }

    @media (max-width: 768px) {
      h2.main-group { font-size: 1.25rem; }
      h4.sub-group { font-size: 1rem; }
      .btn-sm { font-size: 0.9rem; padding: 0.25rem 0.5rem; }
      .nav-header .btn { margin-bottom: 0.5rem; }
      .containerwgt { padding: 0 1rem; }
      .jumpbox .jump-links a { font-size: 0.88rem; }
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="nav-header mb-2">
    <a href="{{ url_for('main_page') }}" class="btn btn-primary btn-sm">Home</a>
    <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Logout</a>
  </div>
  <hr>

  <div class="containerwgt">
    <h2 id="etitle"></h2>
    <div id="lastUpdated" class="text-muted">Last updated: —</div>

    <div class="toggle-buttons mb-2">
      <button id="btn-state-topic" class="btn btn-outline-secondary btn-sm active">Group by State → Topic</button>
      <button id="btn-topic-state" class="btn btn-outline-secondary btn-sm">Group by Topic → State</button>
    </div>

    <!-- NEW: Jump-to list (switches based on toggle) -->
    <div id="jumpBox" class="jumpbox">
      <div id="jumpTitle" class="jump-title">Jump to a state:</div>
      <div id="jumpLinks" class="jump-links"></div>
    </div>

    <div id="articleView"></div>
  </div>
</div>

<script>
const formattedDate = new Date().toLocaleDateString('en-US', {
  year: 'numeric', month: 'long', day: 'numeric'
});
document.getElementById("etitle").textContent = `State News | Top News - ${formattedDate}`;

const csvFilePath = "{{ url_for('uploads', filename='state_summary.csv') }}";

/* timestamps JSON path */
const tsFilePath = "/timestamps/stateSummary.json";

// Convert ISO timestamps to local time
function convertToLocalDate(isoString) {
  const date = new Date(isoString);
  return date.toLocaleString();
}

// Load "last updated" from timestamps JSON
function loadLastUpdated() {
  fetch(tsFilePath, { cache: "no-store" })
    .then(resp => {
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    })
    .then(arr => {
      if (!Array.isArray(arr) || arr.length === 0) {
        document.getElementById("lastUpdated").textContent = "Last updated: —";
        return;
      }
      const last = arr[arr.length - 1];
      const ts = last && last.timestamp ? last.timestamp : null;

      if (!ts) {
        document.getElementById("lastUpdated").textContent = "Last updated: —";
        return;
      }

      const local = convertToLocalDate(ts);
      const count = (last.entries !== undefined && last.entries !== null) ? ` (${last.entries} new)` : "";
      document.getElementById("lastUpdated").textContent = `Last updated: ${local}${count}`;
    })
    .catch(err => {
      console.error("Error loading last updated timestamp:", err);
      document.getElementById("lastUpdated").textContent = "Last updated: —";
    });
}

const allStates = [
  "National", "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado",
  "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois",
  "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland",
  "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana",
  "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York",
  "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania",
  "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah",
  "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming"
];

const allTopics = [
  "State Budget", "K-12 Education", "Public Health", "Public Opinion Polls",
  "Protests and Civil Unrest", "Immigration and Immigration Enforcement"
];

function customSort(a, b) {
  if (a === 'National') return -1;
  if (b === 'National') return 1;
  return a.localeCompare(b);
}

/* NEW: safe slug for IDs */
function slugify(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
}

/* NEW: build jump links based on mode */
function renderJumpLinks(groupMode) {
  const jumpTitle = document.getElementById("jumpTitle");
  const jumpLinks = document.getElementById("jumpLinks");
  jumpLinks.innerHTML = "";

  if (groupMode === "state-topic") {
    jumpTitle.textContent = "Jump to a state:";
    allStates.forEach(st => {
      const id = `main-${slugify(st)}`;
      const a = document.createElement("a");
      a.href = `#${id}`;
      a.textContent = st;
      jumpLinks.appendChild(a);
    });
  } else {
    jumpTitle.textContent = "Jump to a topic:";
    allTopics.forEach(tp => {
      const id = `main-${slugify(tp)}`;
      const a = document.createElement("a");
      a.href = `#${id}`;
      a.textContent = tp;
      jumpLinks.appendChild(a);
    });
  }
}

function loadAndRender(groupMode) {
  // show correct jump list immediately (even before render finishes)
  renderJumpLinks(groupMode);

  d3.csv(csvFilePath, function(data) {
    d3.select('#articleView').html('');

    const nested = d3.nest()
      .key(d => groupMode === 'state-topic' ? d.state : d.topic)
      .sortKeys(groupMode === 'state-topic' ? customSort : d3.ascending)
      .key(d => groupMode === 'state-topic' ? d.topic : d.state)
      .sortKeys(d3.ascending)
      .entries(data);

    const lookup = {};
    nested.forEach(g => {
      lookup[g.key] = {};
      g.values.forEach(sub => {
        lookup[g.key][sub.key] = sub.values;
      });
    });

    const outerList = groupMode === 'state-topic'
      ? allStates
      : Object.keys(lookup).sort();

    outerList.forEach(outer => {
      // main group anchor id: "main-<slug>"
      const outerId = `main-${slugify(outer)}`;

      d3.select('#articleView')
        .append('h2')
        .attr('class', 'main-group')
        .attr('id', outerId)         // NEW: anchor id
        .text(outer);

      const subList = groupMode === 'state-topic'
        ? allTopics
        : Object.keys(lookup[outer] || {}).sort();

      subList.forEach(inner => {
        // sub group anchor id (optional, but handy)
        const innerId = `sub-${slugify(outer)}--${slugify(inner)}`;

        d3.select('#articleView')
          .append('h4')
          .attr('class', 'sub-group')
          .attr('id', innerId)       // NEW: anchor id
          .text(inner);

        const entries = lookup[outer] && lookup[outer][inner];

        let table = d3.select('#articleView')
          .append('table')
          .attr('class', 'table table-borderless table-sm')
          .style('margin-bottom', '1rem');

        if (entries && entries.length > 0) {
          entries.forEach(d => {
            table.append('tr')
              .append('td')
              .html(`
                <p class="article-entry">
                  <small class="outlet">${d.outlet}</small>
                  <b><a href="${d.url}" target="_blank">${d.headline}</a></b><br>
                  ${d.summary}
                </p>`);
          });
        } else {
          table.append('tr')
            .append('td')
            .html(`<p class="article-entry text-muted">No current stories.</p>`);
        }
      });
    });
  });
}

/* initial */
loadAndRender('state-topic');
loadLastUpdated();

/* toggles */
document.getElementById('btn-state-topic').addEventListener('click', () => {
  document.getElementById('btn-state-topic').classList.add('active');
  document.getElementById('btn-topic-state').classList.remove('active');
  loadAndRender('state-topic');
});

document.getElementById('btn-topic-state').addEventListener('click', () => {
  document.getElementById('btn-topic-state').classList.add('active');
  document.getElementById('btn-state-topic').classList.remove('active');
  loadAndRender('topic-state');
});
</script>

</body>
</html>
